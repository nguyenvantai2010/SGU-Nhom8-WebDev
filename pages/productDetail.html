<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi ti·∫øt s·∫£n ph·∫©m</title>
    <link rel="stylesheet" href="../css/globalStyle.css">
    <link rel="stylesheet" href="../css/navbar.css">
    <link rel="stylesheet" href="../css/productDetail.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-inner">
            <div class="nav-left">
                <a href="../index.html" class="brand">Home</a>
            </div>

            <div class="nav-right">
                <a href="about.html">About</a>
                <a href="market.html">Market</a>
                <a href="cart.html">Cart</a>
                <a href="login.html" class="login-btn">Login</a>
            </div>
        </div>

        <div class="burger">
            <div class="line1"></div>
            <div class="line2"></div>
            <div class="line3"></div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="product-container">
        <div class="product-image">
            <img id="product-image" src="" alt="Product Image" onerror="this.src='../assets/images/placeholder.png'">
        </div>
        <div class="product-info">
            <h1 id="product-name"></h1>
            <p class="price">Gi√°: <span id="product-price"></span></p>
            <p class="stock">C√≤n l·∫°i: <span id="product-quantity"></span> s·∫£n ph·∫©m</p>
            <p class="year">NƒÉm xu·∫•t b·∫£n: <span id="product-year"></span></p>
            <p class="description" id="product-description"></p>

            <div class="quantity-control">
                <label for="quantity">S·ªë l∆∞·ª£ng:</label>
                <div class="quantity-wrapper">
                    <button class="quantity-btn minus" onclick="decreaseQuantity()">
                        <i class="fas fa-minus"></i>
                    </button>
                    <input type="number" id="quantity" value="1" min="1" onchange="validateQuantity(this)">
                    <button class="quantity-btn plus" onclick="increaseQuantity()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>

            <button class="add-to-cart-btn" onclick="addToCart()">
                <i class="fas fa-shopping-cart"></i>
                Th√™m v√†o gi·ªè h√†ng
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../src/navbar.js"></script>
    <script type="module" src="../src/cart.js"></script>

    <script>
        // üîπ ƒê·ªãnh d·∫°ng gi√° ti·ªÅn VND
        function formatPrice(price) {
            if (typeof price === 'string') {
                price = parseInt(price.replace(/[^\d]/g, ''), 10);
            }
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }

        // üîπ Gi·∫£m s·ªë l∆∞·ª£ng
        function decreaseQuantity() {
            const quantityInput = document.getElementById('quantity');
            const currentValue = parseInt(quantityInput.value);
            if (currentValue > 1) {
                quantityInput.value = currentValue - 1;
            }
            validateQuantity(quantityInput);
        }

        // üîπ TƒÉng s·ªë l∆∞·ª£ng
        function increaseQuantity() {
            const quantityInput = document.getElementById('quantity');
            const maxQuantity = parseInt(quantityInput.getAttribute('max'));
            const currentValue = parseInt(quantityInput.value);
            
            if (currentValue < maxQuantity) {
                quantityInput.value = currentValue + 1;
            } else {
                alert(`Ch·ªâ c√≤n ${maxQuantity} s·∫£n ph·∫©m trong kho!`);
            }
            validateQuantity(quantityInput);
        }

        // üîπ Ki·ªÉm tra gi√° tr·ªã nh·∫≠p v√†o
        function validateQuantity(input) {
            let value = parseInt(input.value);
            const max = parseInt(input.getAttribute('max'));
            
            if (isNaN(value) || value < 1) {
                value = 1;
                input.value = value;
            } else if (max && value > max) {
                value = max;
                input.value = value;
                alert(`Ch·ªâ c√≤n ${max} s·∫£n ph·∫©m trong kho!`);
            }
        }

        // üîπ Kh·ªüi t·∫°o trang chi ti·∫øt
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const productId = urlParams.get('id');
                
                if (!productId) throw new Error('Missing product ID');

                const marketItems = JSON.parse(localStorage.getItem('marketItems')) || {};
                let product = null;

                for (const category of Object.values(marketItems)) {
                    if (category.items) {
                        product = category.items.find(item => item.id === productId);
                        if (product) break;
                    }
                }

                if (!product) throw new Error('Product not found');

                document.getElementById('product-image').src = product.image;
                document.getElementById('product-name').textContent = product.name;
                document.getElementById('product-price').textContent = formatPrice(product.price);
                document.getElementById('product-quantity').textContent = product.quantity;
                document.getElementById('product-year').textContent = product.releaseYear || 'Kh√¥ng x√°c ƒë·ªãnh';
                document.getElementById('product-description').textContent = product.description || 'Kh√¥ng c√≥ m√¥ t·∫£';

                const quantityInput = document.getElementById('quantity');
                quantityInput.max = product.quantity;
                quantityInput.value = 1;
                quantityInput.addEventListener('input', function() {
                    validateQuantity(this);
                });

            } catch (error) {
                console.error('Error loading product:', error);
                alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin s·∫£n ph·∫©m!');
                window.location.href = 'market.html';
            }
        });
    </script>
</body>
</html>
